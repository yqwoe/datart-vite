import{w as C,u as S,h as a,j as e,e as G,aS as R,eU as O,X as J,y as U,eO as K,dJ as X,eP as q,g9 as Q,fh as Y,fn as Z,g as $,S as F,dY as H,J as ee}from"./entryPointFactory.769a35d1.js";import{gE as A,B as _,aX as te,aq as B,ba as se,gI as oe,fD as ae,gJ as ne,eT as ie,gK as re,gB as le,gG as ce,gL as de,gM as he,gN as me,p as pe,dp as ue}from"./index.1ca238f3.js";import{A as fe,aL as ge,c9 as xe,ca as Se,cb as ke,c8 as ye,aM as je}from"./WidgetMapper.1c4fa18b.js";import{u as M,S as Ce,P as Ie}from"./useRouteQuery.20bf18f6.js";import{Q as we,x as Te,P as Pe,e as ve,N as De,K as _e,ar as Ne,u as Ee}from"./index.e6917ec6.js";import{j as ze,a as Le,d as be,k as Fe,f as He}from"./selectors.caa0f834.js";import{D as Be}from"./index.5bed3aad.js";import{u as L}from"./index.3e5f4c4f.js";import{H as Me}from"./HeadlessBrowserIdentifier.4b0c7724.js";import"./LoginForm.f01daba0.js";import"./AuthLayout.7c6c8571.js";import"./GithubOutlined.a187f62f.js";const Oe=50,Ae=({children:t,...s})=>{const k=S(ze),{shareActions:h}=A(),n=L(),i=a.useCallback(l=>{n(h.setShareDownloadPolling(l))},[n,h]);return e.jsxs(e.Fragment,{children:[e.jsx(We,{children:e.jsx(Be,{polling:k,setPolling:i,renderDom:e.jsx(_,{type:"text",size:"small",ghost:!0,icon:e.jsx(fe,{style:{fontSize:17}}),children:"下载列表"}),...s})}),e.jsx(Ve,{children:t})]})},We=C.div.withConfig({displayName:"DownloadTaskContainer__HeaderArea",componentId:"sc-tyxsje-0"})(["display:flex;flex-direction:row;align-items:center;justify-content:flex-end;"]),Ve=C.div.withConfig({displayName:"DownloadTaskContainer__Content",componentId:"sc-tyxsje-1"})(["height:calc(100% - ","px);"],Oe),z={marginLeft:"20px",fontSize:14,cursor:"pointer"},Ge=a.memo(({name:t,onShareDownloadData:s,loadVizData:k,children:h})=>{const n=G("viz.action"),[i,l]=a.useState(!1),{allowDownload:g}=a.useContext(we);return i?e.jsx(Je,{children:e.jsxs(te,{children:[g&&e.jsxs(e.Fragment,{children:[h,e.jsx(Pe,{placement:"left",title:n("common.confirm"),okText:n("common.ok"),cancelText:n("common.cancel"),onConfirm:()=>{s==null||s()},children:e.jsx(B,{title:n("share.exportData"),placement:"bottom",children:e.jsx(_,{type:"text",size:"small",ghost:!0,icon:e.jsx(ve,{style:z}),children:n("share.exportData")})})})]}),e.jsx(B,{title:n("syncData"),placement:"bottom",children:e.jsx(_,{type:"text",size:"small",ghost:!0,onClick:k,icon:e.jsx(se,{style:z}),children:n("syncData")})}),e.jsx(_,{type:"text",size:"small",ghost:!0,onClick:()=>l(!1),icon:e.jsx(R,{style:z}),children:n("close")})]})}):e.jsx(Re,{onClick:()=>l(!0),children:e.jsx(Te,{})})}),Re=C.div.withConfig({displayName:"TitleForShare__FixedButton",componentId:"sc-b4h4f3-0"})(["position:fixed;top:8px;right:8px;z-index:",";cursor:pointer;"],O),Je=C.div.withConfig({displayName:"TitleForShare__Wrapper",componentId:"sc-b4h4f3-1"})(["position:fixed;z-index:",";display:flex;flex-shrink:0;align-items:center;justify-content:flex-end;width:100%;padding:"," ",";h1{flex:1;font-size:",";font-weight:",";line-height:",";&.disabled{color:",";}}"],O,J,U,K,X,q,t=>t.theme.textColorLight),Ue=60,Ke=a.memo(({dashboard:t,renderMode:s,filterSearchUrl:k,allowDownload:h,loadVizData:n,onMakeShareDownloadDataTask:i,onLoadShareTask:l,onDownloadFile:g})=>{const d=L(),y=S(oe),{needFetchItems:I,hasFetchItems:r,boardWidthHeight:w}=y,[N,j]=a.useState(!1);a.useEffect(()=>{I.length===r.length&&j(!0)},[r,I]);const{taskW:b,taskH:T}=a.useMemo(()=>{var m;const c={taskW:w[0]||0,taskH:w[1]||0};if(t&&((m=t==null?void 0:t.config)==null?void 0:m.type)==="free"){const v=t.config.jsonConfig.props,[D,o]=ae(v,["size"],["width","height"]),p=D/(o||1)||1,u=c.taskW/p;c.taskH=u}return c},[w,t]),f=a.useCallback(c=>async m=>{const{boardId:v}=c,{requestParams:D,fileName:o}=await m(ne({boardId:v}));i(D,o)},[i]),P=a.useCallback(()=>{d(f({boardId:t.id}))},[f,t.id,d]),x=a.useMemo(()=>{var m;const c=(m=t==null?void 0:t.config)==null?void 0:m.type;return!t||!c?null:e.jsx(ge,{board:t,editing:!1,autoFit:!1,renderMode:s,allowDownload:h,children:e.jsxs(Xe,{children:[e.jsx(Ge,{onShareDownloadData:P,loadVizData:n,children:e.jsx(Ae,{onLoadTasks:l,onDownloadFile:g})}),c==="auto"&&e.jsx(xe,{boardId:t.id}),c==="free"&&e.jsx(Se,{boardId:t.id}),e.jsx(ke,{})]})})},[h,t,n,g,l,P,s]);return e.jsxs(De,{backend:_e,children:[x,e.jsx(Me,{renderSign:N,width:Number(b),height:Number(T)+Ue})]})}),Xe=C.div.withConfig({displayName:"DashboardForShare__Wrapper",componentId:"sc-16veihl-0"})(["position:fixed;top:0;right:0;bottom:0;left:0;z-index:",";display:flex;flex-direction:column;padding-bottom:0;background-color:",";"],Q,t=>t.theme.bodyBackground);function lt(){const{shareActions:t}=A();Ne(),ie();const s=L(),k=Y(),h=Z(),n=k.search,i=h.token,[l,g]=a.useState(""),d=S(Le),y=S(be),I=S(Fe),r=S(re),w=S(He),N=!!$(),j=M({key:"type"}),T=M({key:"eager"})?"schedule":"share",f=a.useMemo(()=>ye.toParams(n),[n]);a.useEffect(()=>{r!=null&&r.name&&s(le.savePageTitle({title:r==null?void 0:r.name}))},[r==null?void 0:r.name,s]);const P=()=>{if(j==="CODE"){const o=pe.session.get(i);o?x(i,o,f):s(t.saveNeedVerify(!0))}else j==="LOGIN"&&!N?s(t.saveNeedVerify(!0)):x(i,void 0,f)};Ee(()=>{ue.instance().load().then(()=>P()).catch(o=>{})});const x=a.useCallback((o,p,u,E,W,V)=>{s(ce({shareToken:o,sharePassword:p,filterSearchParams:u,renderMode:T,userName:E,passWord:W,authorizedToken:V}))},[s,T]),c=a.useMemo(()=>{var u;const o=localStorage.getItem(F.ShareClientId);if(o)g(o);else{const E=H();g(E),localStorage.setItem(F.ShareClientId,H())}const p=(u=Object.values(d)[0])==null?void 0:u.authorizedToken;return()=>de({shareToken:p,clientId:l})},[d,l]),m=a.useCallback((o,p)=>{l&&d&&s(he({clientId:l,executeToken:d,downloadParams:o,shareToken:i,fileName:p,resolve:()=>{s(t.setShareDownloadPolling(!0))},password:I}))},[l,i,I,d,s,t]),v=a.useCallback(o=>{var u;const p=(u=Object.values(d)[0])==null?void 0:u.authorizedToken;me({downloadId:o.id,shareToken:p}).then(()=>{s(t.setShareDownloadPolling(!0))})},[d,s,t]),D=a.useCallback(o=>{s(ee({params:o,resolve:()=>{x(i,void 0,f,o.username,o.password)}}))},[s,x,f,i]);return e.jsxs(qe,{className:"datart-viz",children:[e.jsx(Ce,{visible:!!y&&j==="LOGIN",onChange:D}),e.jsx(Ie,{visible:!!y&&j==="CODE",onChange:o=>{x(i,o,f)}}),!w&&!y&&e.jsx("div",{className:"loading-container",children:e.jsx(je,{})}),!y&&r&&e.jsx(Ke,{dashboard:r,allowDownload:!0,loadVizData:P,onMakeShareDownloadDataTask:m,renderMode:T,filterSearchUrl:"",onLoadShareTask:c,onDownloadFile:v})]})}const qe=C.div.withConfig({displayName:"ShareDashboardPage__StyledWrapper",componentId:"sc-120lzhu-0"})(["width:100%;height:100vh;.loading-container{display:flex;height:100vh;}"]);export{lt as default};

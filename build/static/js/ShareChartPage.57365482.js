import{h as g,u as c,j as e,w as Y,fh as En,fn as Tn,g as jn,J as Fn}from"./entryPointFactory.769a35d1.js";import{dp as mn,dx as Mn,gA as en,bw as un,cl as j,fo as Vn,dc as Ln,gB as pn,gC as gn,gD as Bn,gE as Nn,gF as zn,gG as Hn,p as An}from"./index.1ca238f3.js";import{L as Cn,c4 as Jn,c5 as _n,c6 as Gn,ao as qn,I as On,a5 as Wn,a4 as Un,a8 as Kn,a9 as Qn,c7 as Xn,J as Yn,E as Zn,K as $n,c8 as Rn,aM as hn}from"./WidgetMapper.1c4fa18b.js";import{u as X,S as rn,P as vn}from"./useRouteQuery.20bf18f6.js";import{u as wn}from"./index.e6917ec6.js";import{b as Pn,c as ns,a as kn,d as ss,e as os,f as ts,g as ds}from"./selectors.caa0f834.js";import{H as as}from"./HeadlessBrowserIdentifier.4b0c7724.js";import{u as fn}from"./index.3e5f4c4f.js";import"./LoginForm.f01daba0.js";import"./AuthLayout.7c6c8571.js";import"./GithubOutlined.a187f62f.js";const ls=100,es=g.memo(({chartPreview:n,orgId:C,filterSearchParams:J,availableSourceFunctions:O})=>{var $,R,h,r,v,w,P,nn,sn,on;const p=fn(),d=g.useRef(),[F]=g.useState(()=>{var o,t;return mn.instance().getById((t=(o=n==null?void 0:n.backendChart)==null?void 0:o.config)==null?void 0:t.chartGraphId)}),{ref:I,width:s=0,height:W=0}=Cn({refreshMode:"debounce",refreshRate:500}),{ref:U,height:_=0}=Cn({refreshMode:"debounce",refreshRate:500}),E=c(Pn),i=c(ns),Z=c(kn),u=g.useRef(n==null?void 0:n.chartConfig),[f,K]=Jn(),[D,Q]=_n(),[G,q]=Gn(),{getDrillThroughSetting:k,getViewDetailSetting:S,handleDrillThroughEvent:l,handleViewDataEvent:m}=qn({openViewDetailPanel:f,openJumpUrlDialogModal:G.info,openJumpVizDialogModal:D}),T=On({isLoading:n==null?void 0:n.isLoadingData});g.useEffect(()=>{var a;n&&(d.current=Mn((a=n==null?void 0:n.chartConfig)==null?void 0:a.datas,d==null?void 0:d.current),p(en({preview:n,filterSearchParams:J})),Sn(F))},[n,F]);const b=g.useCallback((a,o,t)=>{var y,B,N,z,H,A,tn,dn,an,ln;const x=k((y=u==null?void 0:u.current)==null?void 0:y.interactions,[]);return{drillOption:d==null?void 0:d.current,drillThroughSetting:x,clickEventParams:a,targetEvent:o,orgId:C,view:{id:((N=(B=n==null?void 0:n.backendChart)==null?void 0:B.view)==null?void 0:N.id)||"",config:((z=n==null?void 0:n.backendChart)==null?void 0:z.view.config)||{},meta:(H=n==null?void 0:n.backendChart)==null?void 0:H.view.meta,computedFields:((A=n==null?void 0:n.backendChart)==null?void 0:A.config.computedFields)||[]},queryVariables:((tn=n==null?void 0:n.backendChart)==null?void 0:tn.queryVariables)||[],computedFields:(dn=n==null?void 0:n.backendChart)==null?void 0:dn.config.computedFields,aggregation:(ln=(an=n==null?void 0:n.backendChart)==null?void 0:an.config)==null?void 0:ln.aggregation,chartConfig:u==null?void 0:u.current,ruleId:t,isJumpUrlOnly:!0}},[C,n,k]),M=g.useCallback((a,o)=>{var y,B,N,z,H,A;const t=S((y=u==null?void 0:u.current)==null?void 0:y.interactions,[]),x={id:((N=(B=n==null?void 0:n.backendChart)==null?void 0:B.view)==null?void 0:N.id)||"",config:((z=n==null?void 0:n.backendChart)==null?void 0:z.view.config)||{},meta:(H=n==null?void 0:n.backendChart)==null?void 0:H.view.meta,computedFields:((A=n==null?void 0:n.backendChart)==null?void 0:A.config.computedFields)||[]};return{drillOption:d.current,clickEventParams:a,targetEvent:o,viewDetailSetting:t,chartConfig:u==null?void 0:u.current,view:x}},[n==null?void 0:n.backendChart,S]),V=g.useMemo(()=>{var t;const a=S((t=n==null?void 0:n.chartConfig)==null?void 0:t.interactions,[]),o=!un(i);return(a==null?void 0:a.event)===j.Right&&o?a:void 0},[($=n==null?void 0:n.chartConfig)==null?void 0:$.interactions,S,i]),bn=g.useMemo(()=>{var t,x;const a=k((t=u==null?void 0:u.current)==null?void 0:t.interactions,[]),o=!un(i);return(x=a==null?void 0:a.rules)!=null&&x.filter(y=>y.event===j.Right).length&&o?a:void 0},[k,i]),cn=g.useCallback(()=>{var o;if(k((o=n==null?void 0:n.chartConfig)==null?void 0:o.interactions,[]))return t=>{l(b({selectedItems:i},j.Right,t))}},[(R=n==null?void 0:n.chartConfig)==null?void 0:R.interactions,i,k,l,b]),Dn=g.useCallback(()=>{if(V)return()=>{m(M({selectedItems:i},j.Right))}},[V,i,m,M]),Sn=a=>{a==null||a.registerMouseEvents([{name:"click",callback:o=>{if((o==null?void 0:o.interactionType)===Vn.PagingOrSort){Wn(o,t=>{p(en({...t,preview:n,filterSearchParams:J}))});return}l(b(o,j.Left)),m(M(o,j.Left)),Un(d==null?void 0:d.current,o,t=>{d.current=t,L==null||L(t)}),Kn(o,t=>{L(t)}),Qn(o,t=>{p(pn.changeSelectedItems(t))})}}])},xn=(a,o)=>{var t;p(gn({backendChartId:(t=n==null?void 0:n.backendChart)==null?void 0:t.id,chartPreview:n,payload:o,drillOption:d==null?void 0:d.current}))},L=a=>{var o;d.current=a,p(gn({backendChartId:(o=n==null?void 0:n.backendChart)==null?void 0:o.id,chartPreview:n,payload:null,drillOption:d==null?void 0:d.current}))},yn=(a,o)=>{var t;p(Bn({backendChartId:(t=n==null?void 0:n.backendChart)==null?void 0:t.id,payload:o,drillOption:d==null?void 0:d.current}))},In=g.useMemo(()=>{var a,o,t;return!((a=n==null?void 0:n.backendChart)!=null&&a.viewId)&&((o=n==null?void 0:n.backendChart)!=null&&o.config.sampleData)?(t=n==null?void 0:n.backendChart)==null?void 0:t.config.sampleData:n==null?void 0:n.dataset},[(h=n==null?void 0:n.backendChart)==null?void 0:h.config.sampleData,(r=n==null?void 0:n.backendChart)==null?void 0:r.viewId,n==null?void 0:n.dataset]);return e.jsxs(us,{children:[e.jsx("div",{ref:U,children:e.jsx(Xn,{viewId:(v=n==null?void 0:n.backendChart)==null?void 0:v.viewId,chartConfig:n==null?void 0:n.chartConfig,onChange:xn,view:(w=n==null?void 0:n.backendChart)==null?void 0:w.view,executeToken:Z})}),e.jsxs(Ln.Provider,{value:{drillOption:d.current,availableSourceFunctions:O,viewDetailSetting:V,drillThroughSetting:bn,onDrillOptionChange:L,onDateLevelChange:yn,onDrillThroughChange:cn(),onViewDataChange:Dn()},children:[e.jsx("div",{style:{width:"100%",height:"100%"},ref:I,children:e.jsx(Yn,{chartConfig:n==null?void 0:n.chartConfig,metas:(nn=(P=n==null?void 0:n.backendChart)==null?void 0:P.view)==null?void 0:nn.meta,children:e.jsx(Zn,{containerId:(sn=n==null?void 0:n.backendChart)==null?void 0:sn.id,dataset:In,chart:F,config:n==null?void 0:n.chartConfig,drillOption:d.current,selectedItems:i,width:s,height:W,isLoadingData:T},(on=n==null?void 0:n.backendChart)==null?void 0:on.id)})}),e.jsx(gs,{children:e.jsx($n,{chartConfig:n==null?void 0:n.chartConfig})})]}),e.jsx("div",{children:K},"viewDetailPanelContextHolder"),e.jsx("div",{children:q},"jumpDialogContextHolder"),e.jsx("div",{children:Q},"openJumpVizDialogModalContextHolder"),e.jsx(as,{renderSign:E,width:Number(s)||0,height:Number(s)+Number(_)+ls||0})]})}),us=Y.div.withConfig({displayName:"ChartPreviewBoardForShare__StyledChartPreviewBoardForShare",componentId:"sc-1q87ad-0"})(["display:flex;flex-flow:column;width:100%;height:100%;.chart-drill-menu-container{height:100%;}iframe{flex-grow:1000;}"]),gs=Y.div.withConfig({displayName:"ChartPreviewBoardForShare__StyledChartDrillPathsContainer",componentId:"sc-1q87ad-1"})(["background-color:",";"],n=>n.theme.componentBackground);function Is(){var G,q,k,S;const{shareActions:n}=Nn(),C=fn(),J=En(),O=Tn(),p=J.search,d=O.token,F=!!jn(),I=c(ss),s=c(os),W=c(ts),U=c(ds),_=c(kn);g.useEffect(()=>{var l,m;(l=s==null?void 0:s.backendChart)!=null&&l.name&&C(pn.savePageTitle({title:(m=s==null?void 0:s.backendChart)==null?void 0:m.name}))},[(G=s==null?void 0:s.backendChart)==null?void 0:G.name,C]);const E=X({key:"type"}),i=X({key:"_k"}),u=X({key:"eager"})?"schedule":"share",f=g.useMemo(()=>Rn.toParams(p),[p]),K=()=>{if(E==="CODE"){const l=An.session.get(d)||i;l?D(d,l,f):C(n.saveNeedVerify(!0))}else E==="LOGIN"&&!F?C(n.saveNeedVerify(!0)):D(d,void 0,f)};wn(()=>{mn.instance().load().then(()=>K()).catch(l=>{})}),g.useEffect(()=>{var T,b;const l=(T=s==null?void 0:s.backendChart)==null?void 0:T.view.sourceId,m=(b=s==null?void 0:s.backendChart)==null?void 0:b.view.id;l&&m&&C(zn({sourceId:l,executeToken:_[m].authorizedToken}))},[(q=s==null?void 0:s.backendChart)==null?void 0:q.view.sourceId,(k=s==null?void 0:s.backendChart)==null?void 0:k.view.id,C,_]);const D=g.useCallback((l,m,T,b,M,V)=>{C(Hn({shareToken:l,sharePassword:m,filterSearchParams:T,renderMode:u,userName:b,passWord:M,authorizedToken:V}))},[C,u]),Q=g.useCallback(l=>{C(Fn({params:l,resolve:()=>{D(d,void 0,f,l.username,l.password)}}))},[C,D,f,d]);return e.jsxs(Cs,{className:"datart-viz",children:[e.jsx(rn,{visible:E==="LOGIN"&&!!I,onChange:Q}),e.jsx(vn,{visible:!!I&&E==="CODE",onChange:l=>{D(d,l,f)}}),!W&&!I&&e.jsx("div",{className:"loading-container",children:e.jsx(hn,{})}),!I&&s&&(s==null?void 0:s.backendChart)&&e.jsx(es,{chartPreview:s,orgId:(S=s==null?void 0:s.backendChart)==null?void 0:S.orgId,filterSearchParams:f,availableSourceFunctions:U})]})}const Cs=Y.div.withConfig({displayName:"ShareChartPage__StyledWrapper",componentId:"sc-gpc8vj-0"})(["width:100%;height:100vh;.loading-container{display:flex;height:100vh;}"]);export{Is as ShareChartPage,Is as default};
